import streamlit as st
import yfinance as yf
import requests
import pandas as pd
import datetime
import io
import re
from bs4 import BeautifulSoup

# ==========================================
# âš™ï¸ ç¶²é è¨­å®šå€
# ==========================================
st.set_page_config(page_title="å¸¥å“¥åŸ AI æŠ•é¡§", page_icon="ğŸ˜")

st.title("ğŸ˜ å¸¥å“¥åŸ AI æŠ•é¡§ (ç¶²é ç‰ˆ)")
st.write("ğŸ‘‰ è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ŒAI å¹«ä½ å¾æŠ€è¡“é¢ã€ç±Œç¢¼é¢ã€è²¡å ±é¢é€²è¡Œå¥æª¢ã€‚")

# ==========================================
# ğŸ•µï¸â€â™‚ï¸ æ•¸æ“šæŠ“å–æ¨¡çµ„
# ==========================================

def get_yahoo_web_data(stock_id):
    try:
        url = f"https://tw.stock.yahoo.com/quote/{stock_id}"
        headers = { "User-Agent": "Mozilla/5.0" }
        r = requests.get(url, headers=headers)
        soup = BeautifulSoup(r.text, 'html.parser')
        data = {}

        try:
            title = soup.title.text
            match = re.search(r'^(.+?)\(', title)
            data['Name'] = match.group(1).strip() if match else stock_id
        except: data['Name'] = stock_id

        def find_val(keyword):
            try:
                for item in soup.find_all('li'):
                    if keyword in item.text:
                        # âœ… å¼·åˆ¶æŠ“å–æ•¸å­—ï¼Œä¿®å¾©æ²³æµåœ–å•é¡Œ
                        match = re.search(r'(-?\d+\.\d+|-?\d+)', item.text)
                        if match: return match.group(0)
            except: pass
            return "N/A"

        data['PE'] = find_val("æœ¬ç›Šæ¯”")
        data['PB'] = find_val("è‚¡åƒ¹æ·¨å€¼æ¯”")
        data['Yield'] = find_val("æ®–åˆ©ç‡")
        if data['Yield'] == "N/A": data['Yield'] = find_val("ç¾é‡‘æ®–åˆ©ç‡")

        return data
    except: return {'Name': stock_id, 'PE': 'N/A', 'PB': 'N/A', 'Yield': 'N/A'}

def get_mops_insider(stock_id):
    try:
        clean_id = stock_id.replace(".TW", "").replace(".TWO", "")
        url = "https://mopsov.twse.com.tw/mops/web/ajax_t146sb05"
        now = datetime.datetime.now()
        year, month = now.year - 1911, now.month - 1
        if month == 0: month = 12; year -= 1

        payload = {'encodeURIComponent': '1', 'step': '1', 'firstin': '1', 'off': '1', 'co_id': clean_id, 'year': str(year), 'month': str(month)}
        r = requests.post(url, data=payload, headers={'User-Agent': 'Mozilla/5.0'})
        dfs = pd.read_html(io.StringIO(r.text))
        for df in dfs:
            df.columns = df.columns.astype(str)
            if 'å…¨é«”è‘£ç›£äº‹æŒè‚¡åˆè¨ˆ' in df.to_string():
                val = df.iloc[-1].astype(str).str.extract(r'(\d+\.?\d*)').dropna().iloc[-1, 0]
                return float(val)
    except: return None

def get_chips_yahoo_api(stock_id):
    try:
        url = f"https://tw.stock.yahoo.com/_td-stock/api/resource/StockServices.3MajorTrade:K?symbol={stock_id}"
        r = requests.get(url, headers={"User-Agent": "Mozilla/5.0"})
        data = r.json()
        if 'data' in data and 'list' in data['data'] and len(data['data']['list']) > 0:
            latest = data['data']['list'][0]
            return {
                'foreign': int(latest.get('foreignDiff', 0)) // 1000,
                'trust': int(latest.get('investmentTrustDiff', 0)) // 1000,
                'dealer': int(latest.get('dealerDiff', 0)) // 1000
            }
    except: return None

def calculate_technicals(df):
    df['MA20'] = df['Close'].rolling(window=20).mean()
    df['MA60'] = df['Close'].rolling(window=60).mean()
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))
    exp1 = df['Close'].ewm(span=12, adjust=False).mean()
    exp2 = df['Close'].ewm(span=26, adjust=False).mean()
    df['MACD'] = exp1 - exp2
    df['Signal'] = df['MACD'].ewm(span=9, adjust=False).mean()
    return df

def generate_report(stock_id):
    stock = yf.Ticker(stock_id)
    df = stock.history(period="1y")
    if df.empty: return None

    df = calculate_technicals(df)
    today = df.iloc[-1]
    price = today['Close']
    info = stock.info

    chips = get_chips_yahoo_api(stock_id)
    insider = get_mops_insider(stock_id)
    web_data = get_yahoo_web_data(stock_id)

    score = 50
    reasons = []

    # âœ… ä¿®å¾©äº†é€™è£¡çš„èªæ³•éŒ¯èª¤ (åŠ ä¸Šäº†å†’è™Ÿèˆ‡å®Œæ•´æ¢ä»¶)
    if price > today['MA20']: 
        score += 10
        reasons.append("ç«™ä¸Šæœˆç·š (çŸ­å¤š)")
    else: 
        score -= 10
        reasons.append("è·Œç ´æœˆç·š (çŸ­ç©º)")

    if price > today['MA60']: 
        score += 10
        reasons.append("ç«™ç©©å­£ç·š (é•·å¤š)")
    else: 
        score -= 10

    if today['MACD'] > today['Signal']: score += 5
    if today['RSI'] < 25: 
        score += 10
        reasons.append("RSIè¶…è³£ (é†é‡€åå½ˆ)")

    chip_msg = "æ•¸æ“šä¸è¶³"
    if chips:
        if chips['foreign'] > 0 and chips['trust'] > 0: score += 20; chip_msg = "ğŸ”¥ åœŸæ´‹åˆä¸€ (å¼·åŠ›è²·é€²)"
        elif chips['foreign'] < 0 and chips['trust'] < 0: score -= 20; chip_msg = "â„ï¸ æ³•äººæ£„å®ˆ (è³£å£“é‡)"
        elif chips['trust'] > 0: score += 10; chip_msg = "ğŸ›¡ï¸ æŠ•ä¿¡èªé¤Š"
        else: chip_msg = "âš–ï¸ åœŸæ´‹å°ä½œ"

    score = max(0, min(100, score))

    if score >= 75: verdict = "ğŸŸ¢ å¼·åŠ›è²·é€²"; color = "green"
    elif score >= 55: verdict = "ğŸŸ¡ æŒæœ‰/ä¸­æ€§"; color = "orange"
    elif score >= 40: verdict = "ğŸŸ  è§€æœ›"; color = "brown"
    else: verdict = "ğŸ”´ è³£å‡º/é¿é–‹"; color = "red"

    return {
        "name": web_data.get('Name', stock_id),
        "price": price,
        "score": score,
        "verdict": verdict,
        "color": color,
        "chip_msg": chip_msg,
        "chips": chips,
        "insider": insider,
        "web_data": web_data,
        "today": today,
        "reasons": reasons
    }

# ==========================================
# ğŸ–¥ï¸ UI ä»‹é¢äº’å‹•å€
# ==========================================
user_input = st.text_input("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ (ä¾‹å¦‚: 2330)", "")

if st.button("é–‹å§‹åˆ†æ"):
    if not user_input:
        st.warning("è«‹è¼¸å…¥ä»£ç¢¼ï¼")
    else:
        stock_code = user_input.strip()
        if stock_code.isdigit(): stock_code += ".TW"

        with st.spinner(f"æ­£åœ¨åˆ†æ {stock_code}ï¼Œè«‹ç¨ç­‰..."):
            data = generate_report(stock_code)

        if data:
            st.markdown(f"## {data['name']} ({stock_code})")
            st.markdown(f"### ğŸ† ç¶œåˆè©•åˆ†ï¼š{data['score']} åˆ†")
            st.markdown(f"### ğŸš¦ åˆ¤æ±ºï¼š:{data['color']}[{data['verdict']}]")
            st.divider()
            col1, col2 = st.columns(2)
            with col1:
                st.info("ğŸ“Š **æŠ€è¡“é¢**")
                st.write(f"ç¾åƒ¹ï¼š{data['price']:.1f}")
                st.write(f"æœˆç·šï¼š{data['today']['MA20']:.1f}")
                st.write(f"RSIï¼š{data['today']['RSI']:.1f}")
            with col2:
                st.success("ğŸ’° **åŸºæœ¬/ç±Œç¢¼é¢**")
                st.write(f"æœ¬ç›Šæ¯”ï¼š{data['web_data']['PE']}")
                st.write(f"æ®–åˆ©ç‡ï¼š{data['web_data']['Yield']}%")
                st.write(f"è‘£ç›£æŒè‚¡ï¼š{data['insider']}%")
            st.divider()
            st.write(f"**ä¸»åŠ›å‹•å‘**ï¼š{data['chip_msg']}")
            if data['chips']:
                st.write(f"å¤–è³‡: {data['chips']['foreign']} | æŠ•ä¿¡: {data['chips']['trust']} | è‡ªç‡Ÿ: {data['chips']['dealer']}")
            st.divider()
            st.write("**ğŸ“ è©•åˆ†ç†ç”±ï¼š**")
            for r in data['reasons']:
                st.write(f"- {r}")
        else:
            st.error("æŸ¥ç„¡è³‡æ–™ï¼Œè«‹æª¢æŸ¥ä»£ç¢¼æ˜¯å¦æ­£ç¢ºã€‚")